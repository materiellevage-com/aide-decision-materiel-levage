<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aide au choix ‚Äî Levage | Sp√©cialiste MATERIEL-LEVAGE</title>

  <!-- SEO -->
  <meta name="description" content="Aide au choix levage : qualifiez votre besoin comme avec un sp√©cialiste. Responsabilit√© des choix techniques, r√®gles d'usage, maintenance, conformit√© r√©glementaire. G√©n√©ration d‚Äôun cahier des charges." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://materiellevage-com.github.io/aide-decision-materiel-levage/" />

  <style>
    :root{
      --ml-blue:#2a2e86;
      --ml-blue-dark:#1f2268;
      --ml-yellow:#f2c200;
      --ml-bg:#f5f6fb;
      --ml-card:#ffffff;
      --ml-text:#111827;
      --ml-muted:#6b7280;
      --ml-line:#e5e7eb;
      --ml-shadow:0 10px 25px rgba(17,24,39,.10);
      --ml-radius:16px;

      /* Couleurs catalogue (√† respecter) */
      --cat-accessories:#b10f1b;  /* rouge accessoires */
      --cat-magnets:#22a35a;      /* vert aimants */
      --cat-site:#2b77d9;         /* bleu clair chantier */
      --cat-hoists:#f28c00;       /* orange palans */

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth;}
    body{margin:0;font-family:var(--font);color:var(--ml-text);background:var(--ml-bg)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}

    .topbar{
      background:#fff;
      border-bottom:4px solid var(--cat-accessories);
      box-shadow: 0 6px 20px rgba(17,24,39,.08);
      position:sticky;top:0;z-index:50;
    }
    .topbar-inner{
      max-width:1100px;margin:0 auto;padding:10px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      display:flex;align-items:center;gap:8px;
      font-weight:900;font-size:18px;color:var(--ml-blue);
      white-space:nowrap;
    }
    .logo .dot{
      width:34px;height:34px;border-radius:10px;
      background: radial-gradient(circle at 30% 30%, var(--ml-yellow), #ffd84a);
      border:1px solid rgba(0,0,0,.08);
      display:grid;place-items:center;
      color:var(--ml-blue-dark);font-weight:1000;
    }
    .logo .site{display:flex;align-items:baseline;gap:2px}
    .logo .com{color:var(--ml-yellow);font-weight:1000}
    .subtitle{color:var(--ml-muted);font-size:12px;line-height:1.3}

    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;background:#fff;border:1px solid var(--ml-line);
      font-size:12px;font-weight:800;color:#111827;
    }
    .pill b{color:var(--ml-blue)}
    .statusDot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .statusDot.good{background:var(--good)}
    .statusDot.warn{background:var(--warn)}
    .statusDot.bad{background:var(--bad)}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--ml-card);
      border:1px solid var(--ml-line);
      border-radius:var(--ml-radius);
      box-shadow:var(--ml-shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;border-bottom:1px solid var(--ml-line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background:#fff;
    }
    .card .hd h2{margin:0;font-size:14px;font-weight:1000;color:var(--ml-blue-dark)}
    .card .hd p{margin:6px 0 0;color:var(--ml-muted);font-size:12px;line-height:1.4}
    .card .bd{padding:14px}

    .progressRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}

    .questionBox{
      border:1px solid var(--ml-line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      scroll-margin-top: 90px;
      transition: box-shadow .25s, transform .25s;
    }
    .questionBox.flash{
      box-shadow: 0 0 0 4px rgba(42,46,134,.10), var(--ml-shadow);
      transform: translateY(-1px);
    }

    .askRow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .ask{margin:0;font-size:14px;font-weight:1000;color:#111827;line-height:1.35}
    .askSub{margin:6px 0 0;color:var(--ml-muted);font-size:12px;line-height:1.45}

    .tip{
      position:relative;width:28px;height:28px;border-radius:999px;
      border:1px solid var(--ml-line);background:#fff;
      display:grid;place-items:center;font-weight:1000;color:var(--ml-blue-dark);
      cursor:help;flex:0 0 auto;
    }
    .bubble{
      position:absolute;right:0;top:calc(100% + 10px);
      width:min(460px, calc(100vw - 40px));
      background:#fff;border:1px solid var(--ml-line);
      border-radius:14px;box-shadow:var(--ml-shadow);
      padding:12px;display:none;z-index:60;
    }
    .tip:hover .bubble{display:block}
    .bubble .t{margin:0 0 6px;font-size:12px;font-weight:1000;color:#111827}
    .bubble .p{margin:0;color:var(--ml-muted);font-size:12px;line-height:1.45}

    .opts{display:grid;gap:10px;margin-top:12px}
    .opt{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:14px;border:1px solid var(--ml-line);
      background:#fff;transition:.12s;
    }
    .opt:hover{border-color:#d1d5db;background:#fcfcff}
    .opt input{margin-top:2px;transform:scale(1.08)}
    .opt label{cursor:pointer;flex:1}
    .opt b{display:block;font-size:14px}
    .opt .small{display:block;color:var(--ml-muted);font-size:12px;margin-top:2px;line-height:1.35}

    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
    .btn{
      appearance:none;border:1px solid var(--ml-line);background:#fff;color:#111827;
      border-radius:12px;padding:10px 12px;font-size:13px;font-weight:900;
      cursor:pointer;transition:.12s;
    }
    .btn:hover{background:#f9fafb}
    .btn.core{
      border-color: rgba(42,46,134,.25);
      background: rgba(42,46,134,.08);
      color: var(--ml-blue-dark);
    }
    .btn.core:hover{background: rgba(42,46,134,.11)}
    .btn.neutral{
      border-color: rgba(107,114,128,.25);
      background: rgba(107,114,128,.07);
      color: #111827;
    }
    .btn.neutral:hover{background: rgba(107,114,128,.10)}
    .btn.danger{
      border-color: rgba(177,15,27,.40);
      background: rgba(177,15,27,.10);
      color: #7a0b12;
    }
    .btn.danger:hover{background: rgba(177,15,27,.14)}

    .mini{color:var(--ml-muted);font-size:12px;line-height:1.45;margin-top:8px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--ml-line);vertical-align:top}
    th{font-size:12px;color:var(--ml-muted);text-align:left}
    td{font-size:13px}

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;background:#fbfbff;border:1px solid var(--ml-line);
      border-radius:14px;padding:12px;white-space:pre-wrap;color:#0f172a;
    }

    .seoBlock{
      background:#fff;border:1px solid var(--ml-line);
      border-radius:16px;box-shadow:var(--ml-shadow);
      padding:14px;margin-top:14px;
    }
    .seoBlock h2{margin:0 0 8px;font-size:14px;font-weight:1000;color:var(--ml-blue-dark)}
    .seoBlock p{margin:8px 0;color:var(--ml-muted);font-size:12px;line-height:1.6}
    details{border:1px solid var(--ml-line);border-radius:14px;padding:10px 12px;background:#fff;margin-top:10px}
    summary{cursor:pointer;font-weight:1000;color:#111827;font-size:13px}
    details p{margin:8px 0 0}
    .divider{height:1px;background:var(--ml-line);margin:12px 0}
    ul{margin:10px 0 0;padding-left:18px;color:var(--ml-muted);font-size:12px;line-height:1.55}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-label="MATERIEL-LEVAGE.com">
          <div class="dot">ML</div>
          <div class="site"><span>MATERIEL-LEVAGE</span><span class="com">.com</span></div>
        </div>
        <div>
          <div style="font-weight:1000;color:var(--ml-blue-dark);font-size:18px;line-height:1.15">
            Aide au choix ‚Äî Levage (approche sp√©cialiste)
          </div>
          <div class="subtitle">Un √©change guid√© pour qualifier l‚Äôop√©ration, le comportement de la charge et le niveau d‚Äôexigence (s√©curit√©, positionnement, ma√Ætrise du centre de gravit√©).</div>
        </div>
      </div>

      <div class="top-actions">
        <span class="pill"><span class="statusDot warn" id="dot"></span><span id="statusTxt">√Ä compl√©ter</span></span>
        <span class="pill">Pr√©cision : <b id="clarityTxt">100%</b></span>
        <button class="btn" id="resetBtn" type="button">R√©initialiser</button>
        <button class="btn core" id="demoBtn" type="button">Pr√©remplir d√©mo</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- SEO -->
    <section class="seoBlock" aria-label="Expertise levage">
      <h2>Une m√©thode de sp√©cialiste, pas un simple choix produit</h2>
      <p>
        Le levage engage des <b>choix techniques</b> et des <b>responsabilit√©s</b> : nature de l‚Äôop√©ration, stabilit√©, mode de prise, centre de gravit√©, variabilit√© des charges, niveau d‚Äôexigence (s√©curit√©/positionnement).
        Cette page transforme votre demande en <b>cahier des charges</b> clair pour l‚Äôarbitrage, l‚Äôinstallation, l‚Äôexploitation et la maintenance.
      </p>
    </section>

    <div class="grid">
      <!-- Questions -->
      <div class="card">
        <div class="hd">
          <div>
            <h2>Conversation guid√©e</h2>
            <p>Apr√®s ‚ÄúValider‚Äù ou ‚ÄúJe ne sais pas‚Äù, la question suivante s‚Äôaffiche automatiquement.</p>
          </div>
        </div>

        <div class="bd">
          <div class="questionBox" id="questionBox">
            <div class="askRow">
              <div>
                <p class="ask" id="ask">‚Äî</p>
                <p class="askSub" id="askSub">‚Äî</p>
                <div class="progressRow">
                  <span class="pill" id="stepPill"><b id="stepTxt">1</b> / 8</span>
                  <span class="pill">R√©ponses donn√©es : <b id="answeredTxt">0</b></span>
                </div>
              </div>
              <div class="tip">i
                <div class="bubble">
                  <p class="t" id="tipTitle">Aide</p>
                  <p class="p" id="tipText">‚Äî</p>
                </div>
              </div>
            </div>

            <div class="opts" id="opts"></div>

            <div class="actions">
              <button class="btn core" id="validateBtn" type="button">Valider ma r√©ponse</button>
              <button class="btn neutral" id="dontKnowBtn" type="button">Je ne sais pas</button>
              <button class="btn" id="backBtn" type="button">Retour</button>
              <button class="btn" id="skipToSummaryBtn" type="button">Voir la synth√®se</button>
            </div>

            <div class="mini" id="msg"></div>
          </div>
        </div>
      </div>

      <!-- Synth√®se -->
      <div class="card" id="summaryCard">
        <div class="hd">
          <div>
            <h2>Synth√®se & Cahier des charges</h2>
            <p>La pr√©cision baisse si certaines informations sont inconnues.</p>
          </div>
        </div>
        <div class="bd">
          <table>
            <thead><tr><th>√âl√©ment</th><th>Votre r√©ponse</th></tr></thead>
            <tbody id="summary"></tbody>
          </table>

          <div class="divider"></div>

          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
            <div style="font-weight:1000;color:var(--ml-blue-dark)">Cahier des charges (copiable)</div>
            <div class="mini" id="complexity">‚Äî</div>
          </div>
          <div class="mono" id="cdc">‚Äî</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn core" id="copyBtn" type="button">Copier</button>
            <button class="btn" id="downloadBtn" type="button">T√©l√©charger (.txt)</button>
            <button class="btn danger" id="callBtn" type="button">Contacter un sp√©cialiste</button>
          </div>

          <ul id="alerts"></ul>
        </div>
      </div>
    </div>

    <!-- FAQ (SEO) -->
    <section class="seoBlock" aria-label="FAQ levage">
      <h2>FAQ ‚Äî cadrer une demande de levage</h2>

      <details>
        <summary>Pourquoi demander le mode de prise et le centre de gravit√© ?</summary>
        <p>Parce que la stabilit√©, le ballant, l‚Äôinclinaison et la s√©curit√© d√©pendent directement de la prise de charge et du centre de gravit√©. C‚Äôest un point discriminant de s√©lection.</p>
      </details>

      <details>
        <summary>Pourquoi la variabilit√© des charges est importante ?</summary>
        <p>Une charge unique n‚Äôimpose pas les m√™mes contraintes qu‚Äôune diversit√© de g√©om√©tries/poids/centres de gravit√© : cela influence la solution (r√©glages, polyvalence, s√©curit√© d‚Äôexploitation).</p>
      </details>

      <details>
        <summary>Que faire si je ne sais pas r√©pondre ?</summary>
        <p>Utilisez ‚ÄúJe ne sais pas‚Äù : vous avancez quand m√™me, mais la pr√©cision du cahier des charges baisse et un √©change sp√©cialiste devient recommand√©.</p>
      </details>
    </section>

  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    function focusQuestionBox(){
      const box = $("questionBox");
      if(!box) return;
      box.scrollIntoView({behavior:"smooth", block:"start"});
      box.classList.remove("flash");
      void box.offsetWidth;
      box.classList.add("flash");
      setTimeout(()=>box.classList.remove("flash"), 550);
    }
    function focusSummary(){
      const el = $("summaryCard");
      if(!el) return;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // -----------------------------
    // FLOW (8 questions effectives)
    // -----------------------------
    const flow = [
      {
        id:"action",
        title:"Pour commencer : qu‚Äôavez-vous besoin de faire avec la charge ?",
        sub:"Vous pouvez choisir plusieurs actions si besoin.",
        tipTitle:"Aide ‚Äî Action",
        tip:"On d√©crit ce que vous faites (pas un produit) : lever, d√©placer, accrocher/saisir, ou pr√©voir une structure.",
        type:"multi",
        options:[
          { id:"lift", label:"Lever la charge", help:"Soulever verticalement (mont√©e / descente)." },
          { id:"move", label:"D√©placer la charge", help:"D√©placer vers une ou plusieurs positions." },
          { id:"hook", label:"Accrocher / saisir la charge", help:"Mettre la charge en prise pour la lever ou la maintenir." },
          { id:"support", label:"Pr√©voir une structure", help:"Structure porteuse (potence, portique, etc.)." }
        ]
      },

      {
        id:"movement",
        title:"Quel(s) mouvement(s) devez-vous r√©aliser ?",
        sub:"Cochez tout ce qui s‚Äôapplique (m√™me si c‚Äôest partiel ou occasionnel).",
        tipTitle:"Aide ‚Äî Mouvements",
        tip:"Inclinaison/basculement/retournement = complexit√© plus √©lev√©e ‚Üí souvent besoin de validation technique.",
        type:"multi",
        gate:(s)=> (s.action?.includes("lift") || s.action?.includes("move")),
        options:[
          { id:"v_updown", label:"Lever / descendre (vertical)", help:"Mont√©e/descente." },
          { id:"h_onesense", label:"D√©placer horizontalement ‚Äî un sens", help:"Translation sur un axe." },
          { id:"h_multisense", label:"D√©placer horizontalement ‚Äî plusieurs sens", help:"Plusieurs directions/positions." },
          { id:"tilt", label:"Incliner la charge", help:"Modifier l‚Äôangle (mise √† niveau/positionnement)." },
          { id:"tip", label:"Basculer la charge", help:"Passage contr√¥l√© d‚Äôune position √† une autre." },
          { id:"flip", label:"Retourner la charge (180¬∞)", help:"Retournement complet." }
        ]
      },

      {
        id:"location",
        title:"O√π se d√©roule l‚Äôop√©ration ?",
        sub:"Choisissez ce qui correspond le mieux, puis indiquez si c‚Äôest multi-sites.",
        tipTitle:"Aide ‚Äî Localisation",
        tip:"La localisation influence l‚Äôinstallation, la mobilit√©, et la logique de support (fixe / mobile).",
        type:"mixed",
        gate:(s)=> (s.action?.includes("lift") || s.action?.includes("move")),
        optionsRadio:[
          { id:"station", label:"Un poste de travail d√©di√©", help:"Toujours au m√™me endroit." },
          { id:"zone", label:"Une zone de travail d√©finie", help:"D√©placements sur plusieurs m√®tres." },
          { id:"multi", label:"Plusieurs postes / zones", help:"Emplacements distincts." }
        ],
        optionCheck:{ id:"multisite", label:"Option : multi-sites", help:"Ateliers / b√¢timents / sites diff√©rents." }
      },

      // (Q4) La charge a-t-elle des ancrages ?
      {
        id:"anchorsPresence",
        title:"La charge dispose-t-elle de points d‚Äôancrage (anneaux, anses, points pr√©vus) ?",
        sub:"Si non : la prise se fait par pince, ventouse, aimant, etc.",
        tipTitle:"Aide ‚Äî Points d‚Äôancrage",
        tip:"S‚Äôil n‚Äôy a pas de points d‚Äôancrage, la compatibilit√© d√©pend du principe de prise (surface, mati√®re, g√©om√©trie).",
        type:"mixed_yesno",
        gate:(s)=> s.action?.includes("hook"),
        yesLabel:"Oui, il y a des points d‚Äôancrage",
        noLabel:"Non, il n‚Äôy a pas de points d‚Äôancrage",
        extraCheck:{ id:"dedicated", label:"Option : points d√©di√©s au levage", help:"Points pr√©vus/valid√©s par le fabricant ou la conception." }
      },

      // (Q5) D√©tail ancrages (nombre) OU mode de prise (si pas d‚Äôancrage)
      {
        id:"anchorOrGrip",
        title:"Pour √™tre s√ªr : comment la charge est-elle prise ?",
        sub:"Selon la r√©ponse pr√©c√©dente : nombre de points, ou m√©thode de prise.",
        tipTitle:"Aide ‚Äî Prise de charge",
        tip:"Multipoints = r√©partition/angles. Sans ancrage = principe physique (serrage, d√©pression, magn√©tisme).",
        type:"conditional_single",
        gate:(s)=> s.action?.includes("hook"),
        when:(s)=> s.anchorsPresence, // true/false
        ifTrue:{
          key:"anchorPoints",
          title:"Combien de points d‚Äôancrage utilisez-vous ?",
          options:[
            { id:"p1", label:"1 point", help:"Accrochage simple." },
            { id:"p2", label:"2 points", help:"R√©partition √† v√©rifier." },
            { id:"p3", label:"3 points", help:"R√©glage souvent n√©cessaire." },
            { id:"p4", label:"4 points", help:"Angles critiques : validation recommand√©e." }
          ]
        },
        ifFalse:{
          key:"gripMethod",
          title:"Sans points d‚Äôancrage : quelle m√©thode de prise est envisageable ?",
          options:[
            { id:"positive", label:"Prise positive", help:"Accrochage m√©canique par forme/√©paulement." },
            { id:"clamp", label:"Serrage (pince)", help:"Maintien par pression." },
            { id:"suction", label:"Ventouses", help:"Surface compatible, √©tanch√©it√©." },
            { id:"mag", label:"Aimants", help:"Uniquement ferromagn√©tique." }
          ]
        }
      },

      // (Q6) Centre de gravit√©
      {
        id:"cog",
        title:"Comment est positionn√© le centre de gravit√© de la charge ?",
        sub:"M√™me approximatif : cela d√©termine la stabilit√© et le risque d‚Äôinclinaison/basculement.",
        tipTitle:"Aide ‚Äî Centre de gravit√©",
        tip:"Un CG d√©centr√© ou sous les points d‚Äôaccroche peut cr√©er une rotation non d√©sir√©e et imposer une solution plus encadr√©e.",
        type:"single",
        gate:(s)=> (s.action?.includes("lift") || s.action?.includes("move") || s.action?.includes("hook")),
        options:[
          { id:"center", label:"Centre de gravit√© centr√©", help:"Stabilit√© plus naturelle." },
          { id:"decenter", label:"Centre de gravit√© d√©centr√©", help:"Inclinaison possible." },
          { id:"below", label:"Centre de gravit√© sous les points / instable", help:"Risque de basculement/retournement." }
        ]
      },

      // (Q7) Variabilit√© des charges
      {
        id:"loadVariability",
        title:"Les charges √† manutentionner sont-elles toujours similaires ?",
        sub:"On parle de g√©om√©trie, poids et centre de gravit√©.",
        tipTitle:"Aide ‚Äî Variabilit√©",
        tip:"Plus la diversit√© est grande, plus la solution doit √™tre polyvalente et l‚Äôexploitation doit √™tre encadr√©e (proc√©dure, r√©glages, contr√¥le).",
        type:"single",
        gate:(s)=> (s.action?.includes("lift") || s.action?.includes("move") || s.action?.includes("hook")),
        options:[
          { id:"unique", label:"Charge unique ou tr√®s proche", help:"Poids/g√©om√©trie/CG tr√®s similaires." },
          { id:"variation", label:"Variations ma√Ætris√©es", help:"Quelques variations de poids/CG/forme." },
          { id:"diverse", label:"Grande diversit√©", help:"Charges tr√®s diff√©rentes selon les cas." }
        ]
      },

      // (Q8) Mode de manutention attendu (s√©curit√© / pr√©cision / horizontale CG)
      {
        id:"handlingMode",
        title:"Quel est le mode de manutention attendu ?",
        sub:"Choisissez ce qui d√©crit le mieux l‚Äôexigence d‚Äôexploitation.",
        tipTitle:"Aide ‚Äî Exigence",
        tip:"On traduit l‚Äôexigence en contraintes : vitesse, ma√Ætrise du ballant, stabilit√©/inclinaison, contr√¥le horizontal du centre de gravit√©.",
        type:"single",
        gate:(s)=> (s.action?.includes("lift") || s.action?.includes("move") || s.action?.includes("hook")),
        options:[
          { id:"safe", label:"S√©curitaire / robuste", help:"Priorit√© √† la ma√Ætrise et √† la s√©curit√© d‚Äôexploitation." },
          { id:"precise", label:"Pr√©cise de positionnement", help:"Contr√¥le fin, peu d‚Äô√†-coups, ballant limit√©." },
          { id:"h_cg", label:"D√©placement horizontal ma√Ætrisant le centre de gravit√©", help:"Maintien du CG, stabilit√© et orientation." }
        ]
      }
    ];

    const state = {};
    const dontKnowCount = { total:0, byId:{} };
    let stepIndex = 0;
    const visibleSteps = [];

    function buildVisibleSteps(){
      visibleSteps.length = 0;
      flow.forEach((q, idx)=>{
        const ok = q.gate ? !!q.gate(state) : true;
        if(ok) visibleSteps.push(idx);
      });
      if(stepIndex >= visibleSteps.length) stepIndex = visibleSteps.length - 1;
      if(stepIndex < 0) stepIndex = 0;
    }

    function answeredCount(){
      let n = 0;
      for(const k of Object.keys(state)){
        if(state[k] !== null && state[k] !== undefined) n++;
      }
      return n;
    }

    function precisionScore(){
      let score = 100;
      score -= dontKnowCount.total * 10;

      if(!state.action || state.action.length===0) score -= 40;

      if((state.action?.includes("lift") || state.action?.includes("move")) && (!state.movement || state.movement.length===0)) score -= 12;
      if((state.action?.includes("lift") || state.action?.includes("move")) && !state.location) score -= 10;

      if(state.action?.includes("hook")){
        if(state.anchorsPresence === undefined || state.anchorsPresence === null) score -= 10;
        if(state.anchorsPresence === true && !state.anchorPoints) score -= 10;
        if(state.anchorsPresence === false && !state.gripMethod) score -= 10;
      }

      if(!state.cog) score -= 8;
      if(!state.loadVariability) score -= 6;
      if(!state.handlingMode) score -= 8;

      score = Math.max(0, Math.min(100, Math.round(score)));
      return score;
    }

    function statusFromScore(score){
      if(score >= 85) return { txt:"Demande bien qualifi√©e", dot:"good" };
      if(score >= 65) return { txt:"Demande √† pr√©ciser", dot:"warn" };
      return { txt:"Besoin √† cadrer", dot:"bad" };
    }

    function complexity(){
      const mv = state.movement || [];
      if(mv.includes("flip")) return "Complexit√© : Hors standard";
      if(mv.includes("tip") || mv.includes("tilt") || state.handlingMode === "h_cg" || state.handlingMode === "precise") return "Complexit√© : √âlev√©e";
      return "Complexit√© : Mod√©r√©e";
    }

    function esc(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function setHeader(){
      const score = precisionScore();
      const st = statusFromScore(score);
      $("clarityTxt").textContent = score + "%";
      $("statusTxt").textContent = st.txt;
      $("dot").className = "statusDot " + st.dot;
    }

    function setStepPills(){
      $("stepPill").innerHTML = `<b>${stepIndex + 1}</b> / ${visibleSteps.length}`;
      $("answeredTxt").textContent = String(answeredCount());
    }

    function renderCurrent(){
      buildVisibleSteps();
      setHeader();
      setStepPills();
      $("msg").textContent = "";

      const q = flow[ visibleSteps[stepIndex] ];
      $("ask").textContent = q.title;
      $("askSub").textContent = q.sub || "";
      $("tipTitle").textContent = q.tipTitle || "Aide";
      $("tipText").textContent = q.tip || "";

      const opts = $("opts");
      opts.innerHTML = "";

      if(q.type === "multi"){
        (q.options||[]).forEach(o=>{
          const id = `opt_${q.id}_${o.id}`;
          const checked = (state[q.id] || []).includes(o.id);
          opts.insertAdjacentHTML("beforeend", `
            <div class="opt">
              <input type="checkbox" id="${id}" ${checked ? "checked":""}>
              <label for="${id}">
                <b>${esc(o.label)}</b>
                <span class="small">${esc(o.help || "")}</span>
              </label>
            </div>
          `);
        });
      }

      if(q.type === "single"){
        (q.options||[]).forEach(o=>{
          const id = `opt_${q.id}_${o.id}`;
          const checked = (state[q.id] === o.id);
          opts.insertAdjacentHTML("beforeend", `
            <div class="opt">
              <input type="radio" name="radio_${q.id}" id="${id}" ${checked ? "checked":""}>
              <label for="${id}">
                <b>${esc(o.label)}</b>
                <span class="small">${esc(o.help || "")}</span>
              </label>
            </div>
          `);
        });
      }

      if(q.type === "mixed"){
        (q.optionsRadio||[]).forEach(o=>{
          const id = `opt_${q.id}_${o.id}`;
          const checked = (state[q.id] === o.id);
          opts.insertAdjacentHTML("beforeend", `
            <div class="opt">
              <input type="radio" name="radio_${q.id}" id="${id}" ${checked ? "checked":""}>
              <label for="${id}">
                <b>${esc(o.label)}</b>
                <span class="small">${esc(o.help || "")}</span>
              </label>
            </div>
          `);
        });
        const oc = q.optionCheck;
        if(oc){
          const cid = `opt_${q.id}_${oc.id}`;
          const cchecked = !!state[`${q.id}_${oc.id}`];
          opts.insertAdjacentHTML("beforeend", `
            <div class="opt">
              <input type="checkbox" id="${cid}" ${cchecked ? "checked":""}>
              <label for="${cid}">
                <b>${esc(oc.label)}</b>
                <span class="small">${esc(oc.help || "")}</span>
              </label>
            </div>
          `);
        }
      }

      if(q.type === "mixed_yesno"){
        const yesId = `opt_${q.id}_yes`;
        const noId  = `opt_${q.id}_no`;
        const val = state[q.id];
        opts.insertAdjacentHTML("beforeend", `
          <div class="opt">
            <input type="radio" name="radio_${q.id}" id="${yesId}" ${val === true ? "checked":""}>
            <label for="${yesId}">
              <b>${esc(q.yesLabel)}</b>
              <span class="small">La charge poss√®de des points d‚Äôancrage utilisables.</span>
            </label>
          </div>
          <div class="opt">
            <input type="radio" name="radio_${q.id}" id="${noId}" ${val === false ? "checked":""}>
            <label for="${noId}">
              <b>${esc(q.noLabel)}</b>
              <span class="small">La prise doit se faire autrement (pince, ventouse, aimant‚Ä¶).</span>
            </label>
          </div>
        `);

        const ex = q.extraCheck;
        if(ex){
          const cid = `opt_${q.id}_${ex.id}`;
          const cchecked = !!state[`${q.id}_${ex.id}`];
          opts.insertAdjacentHTML("beforeend", `
            <div class="opt">
              <input type="checkbox" id="${cid}" ${cchecked ? "checked":""}>
              <label for="${cid}">
                <b>${esc(ex.label)}</b>
                <span class="small">${esc(ex.help || "")}</span>
              </label>
            </div>
          `);
        }
      }

      if(q.type === "conditional_single"){
        const cond = q.when(state); // true/false
        const payload = cond ? q.ifTrue : q.ifFalse;

        // on affiche le titre sp√©cifique (sans casser l'en-t√™te global)
        opts.insertAdjacentHTML("beforeend", `
          <div class="opt" style="border-style:dashed;background:#fbfbff">
            <div style="font-weight:1000">${esc(payload.title)}</div>
          </div>
        `);

        (payload.options||[]).forEach(o=>{
          const id = `opt_${q.id}_${payload.key}_${o.id}`;
          const checked = (state[payload.key] === o.id);
          opts.insertAdjacentHTML("beforeend", `
            <div class="opt">
              <input type="radio" name="radio_${q.id}_${payload.key}" id="${id}" ${checked ? "checked":""}>
              <label for="${id}">
                <b>${esc(o.label)}</b>
                <span class="small">${esc(o.help || "")}</span>
              </label>
            </div>
          `);
        });
      }

      $("backBtn").style.display = (stepIndex === 0) ? "none" : "inline-block";
    }

    function collectCurrentAnswer(){
      const q = flow[ visibleSteps[stepIndex] ];

      if(q.type === "multi"){
        const selected = [];
        (q.options||[]).forEach(o=>{
          const el = $(`opt_${q.id}_${o.id}`);
          if(el && el.checked) selected.push(o.id);
        });
        return selected;
      }

      if(q.type === "single"){
        let picked = null;
        (q.options||[]).forEach(o=>{
          const el = $(`opt_${q.id}_${o.id}`);
          if(el && el.checked) picked = o.id;
        });
        return picked;
      }

      if(q.type === "mixed"){
        let picked = null;
        (q.optionsRadio||[]).forEach(o=>{
          const el = $(`opt_${q.id}_${o.id}`);
          if(el && el.checked) picked = o.id;
        });
        const oc = q.optionCheck;
        const ck = oc ? ($(`opt_${q.id}_${oc.id}`)?.checked || false) : false;
        return { radio:picked, check:ck };
      }

      if(q.type === "mixed_yesno"){
        const yes = $(`opt_${q.id}_yes`)?.checked || false;
        const no  = $(`opt_${q.id}_no`)?.checked  || false;
        let picked = null;
        if(yes) picked = true;
        if(no) picked = false;
        const ex = q.extraCheck;
        const ck = ex ? ($(`opt_${q.id}_${ex.id}`)?.checked || false) : false;
        return { yn:picked, extra:ck };
      }

      if(q.type === "conditional_single"){
        const cond = q.when(state);
        const payload = cond ? q.ifTrue : q.ifFalse;
        let picked = null;
        (payload.options||[]).forEach(o=>{
          const el = $(`opt_${q.id}_${payload.key}_${o.id}`);
          if(el && el.checked) picked = o.id;
        });
        return { key: payload.key, value: picked };
      }

      return null;
    }

    function saveAnswer(answer, isDontKnow=false){
      const q = flow[ visibleSteps[stepIndex] ];

      if(isDontKnow){
        dontKnowCount.total += 1;
        dontKnowCount.byId[q.id] = (dontKnowCount.byId[q.id] || 0) + 1;

        // on marque la question comme "connue inconnue"
        if(state[q.id] === undefined) state[q.id] = null;
        return true;
      }

      if(q.type === "mixed"){
        state[q.id] = answer.radio;
        state[`${q.id}_${q.optionCheck.id}`] = !!answer.check;
        return true;
      }

      if(q.type === "mixed_yesno"){
        state[q.id] = answer.yn;
        if(q.extraCheck){
          state[`${q.id}_${q.extraCheck.id}`] = !!answer.extra;
        }
        // nettoyage coh√©rent si on change d'avis
        if(answer.yn === true){
          delete state.gripMethod;
        }
        if(answer.yn === false){
          delete state.anchorPoints;
          state[`${q.id}_dedicated`] = false;
        }
        return true;
      }

      if(q.type === "conditional_single"){
        state[answer.key] = answer.value;
        return true;
      }

      state[q.id] = answer;
      return true;
    }

    function next(){
      buildVisibleSteps();
      if(stepIndex < visibleSteps.length - 1){
        stepIndex += 1;
        renderCurrent();
        renderSummary();
        focusQuestionBox();
      } else {
        renderSummary(true);
        $("msg").textContent = "Fin des questions ‚Äî la synth√®se est √† droite ‚úÖ";
        focusSummary();
      }
      setHeader();
      setStepPills();
    }

    function back(){
      if(stepIndex > 0){
        stepIndex -= 1;
        renderCurrent();
        renderSummary();
        focusQuestionBox();
      }
      setHeader();
      setStepPills();
    }

    function validate(){
      $("msg").textContent = "";
      const q = flow[ visibleSteps[stepIndex] ];
      const ans = collectCurrentAnswer();

      let ok = true;
      if(q.type === "multi") ok = ans.length > 0;
      if(q.type === "single") ok = !!ans;
      if(q.type === "mixed") ok = !!ans.radio;
      if(q.type === "mixed_yesno") ok = (ans.yn === true || ans.yn === false);
      if(q.type === "conditional_single") ok = !!ans.value;

      if(!ok){
        $("msg").textContent = "Veuillez s√©lectionner une r√©ponse, ou utilisez ¬´ Je ne sais pas ¬ª.";
        $("msg").style.color = "var(--bad)";
        return;
      }

      saveAnswer(ans, false);
      buildVisibleSteps();

      $("msg").textContent = "R√©ponse enregistr√©e ‚úÖ";
      $("msg").style.color = "var(--good)";
      next();
    }

    function dontKnow(){
      $("msg").textContent = "";
      saveAnswer(null, true);

      $("msg").textContent = "D‚Äôaccord ‚Äî on continue. (La pr√©cision de la demande baisse)";
      $("msg").style.color = "var(--warn)";
      next();
    }

    function renderSummary(forceFocus=false){
      const tb = $("summary");
      tb.innerHTML = "";

      const score = precisionScore();
      $("complexity").textContent = complexity();

      const rows = [];

      const actMap = { lift:"Lever", move:"D√©placer", hook:"Accrocher/saisir", support:"Pr√©voir une structure" };
      const act = state.action?.length ? state.action.map(x=>actMap[x]||x).join(", ") : "‚Äî";
      rows.push(["Action sur la charge", act]);

      if(state.action?.includes("lift") || state.action?.includes("move")){
        const mvMap = {
          v_updown:"Lever/descendre (vertical)",
          h_onesense:"Horizontal ‚Äî un sens",
          h_multisense:"Horizontal ‚Äî plusieurs sens",
          tilt:"Incliner",
          tip:"Basculer",
          flip:"Retourner (180¬∞)"
        };
        const mv = (state.movement && state.movement.length) ? state.movement.map(x=>mvMap[x]||x).join(", ") : "‚Äî";
        rows.push(["Mouvements", mv]);
      }

      if(state.action?.includes("lift") || state.action?.includes("move")){
        const locMap = { station:"Un poste d√©di√©", zone:"Une zone d√©finie", multi:"Plusieurs postes/zones" };
        const loc = state.location ? (locMap[state.location]||state.location) : "‚Äî";
        const ms = state["location_multisite"] ? " + multi-sites" : "";
        rows.push(["Localisation", loc + ms]);
      }

      if(state.action?.includes("hook")){
        const ap = state.anchorsPresence;
        if(ap === true){
          rows.push(["Points d‚Äôancrage", "Oui"]);
          rows.push(["Points d√©di√©s au levage", state["anchorsPresence_dedicated"] ? "Oui" : "Non / inconnu"]);
          const ptsMap = { p1:"1 point", p2:"2 points", p3:"3 points", p4:"4 points" };
          rows.push(["Nombre de points", state.anchorPoints ? (ptsMap[state.anchorPoints]||state.anchorPoints) : "‚Äî"]);
        } else if(ap === false){
          rows.push(["Points d‚Äôancrage", "Non"]);
          const gripMap = { positive:"Prise positive", clamp:"Serrage (pince)", suction:"Ventouses", mag:"Aimants" };
          rows.push(["M√©thode de prise", state.gripMethod ? (gripMap[state.gripMethod]||state.gripMethod) : "‚Äî"]);
        } else {
          rows.push(["Points d‚Äôancrage", "‚Äî"]);
        }
      }

      const cgMap = { center:"Centr√©", decenter:"D√©centr√©", below:"Sous les points / instable" };
      rows.push(["Centre de gravit√©", state.cog ? (cgMap[state.cog]||state.cog) : "‚Äî"]);

      const varMap = { unique:"Unique / proche", variation:"Variations ma√Ætris√©es", diverse:"Grande diversit√©" };
      rows.push(["Variabilit√© des charges", state.loadVariability ? (varMap[state.loadVariability]||state.loadVariability) : "‚Äî"]);

      const hmMap = { safe:"S√©curitaire / robuste", precise:"Pr√©cise de positionnement", h_cg:"Horizontale ma√Ætrisant le CG" };
      rows.push(["Mode de manutention", state.handlingMode ? (hmMap[state.handlingMode]||state.handlingMode) : "‚Äî"]);

      rows.forEach(([a,b])=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${esc(a)}</td><td>${esc(b)}</td>`;
        tb.appendChild(tr);
      });

      // Alerts
      const alerts = [];
      const mv = state.movement || [];
      if(mv.includes("flip")) alerts.push("Retourner une charge : validation technique recommand√©e (stabilit√©, efforts, mode de prise).");
      if(mv.includes("tip") || mv.includes("tilt")) alerts.push("Incliner/basculer : pr√©ciser l‚Äôangle et la stabilit√© attendus.");
      if(state.anchorPoints === "p3" || state.anchorPoints === "p4") alerts.push("Accrochage multipoints : pr√©ciser les angles et la r√©partition.");
      if(state.cog === "below") alerts.push("Centre de gravit√© instable : risque de basculement/retournement.");
      if(state.loadVariability === "diverse") alerts.push("Grande diversit√© : solution polyvalente + proc√©dure d‚Äôexploitation recommand√©e.");
      if(state.handlingMode === "precise") alerts.push("Pr√©cision √©lev√©e : privil√©gier ma√Ætrise du ballant/√†-coups et contr√¥le fin.");
      if(state.handlingMode === "h_cg") alerts.push("Exigence ‚Äúhorizontale ma√Ætrisant le CG‚Äù : pr√©ciser trajectoire/contr√¥le et stabilit√©.");
      if(state["location_multisite"]) alerts.push("Multi-sites : pr√©ciser mobilit√©, montage/d√©montage, transport.");
      if(dontKnowCount.total>0) alerts.push("Certaines r√©ponses sont inconnues : la pr√©cision du cahier des charges est r√©duite.");

      const ul = $("alerts");
      ul.innerHTML = "";
      if(alerts.length===0){
        const li = document.createElement("li");
        li.textContent = "Aucune alerte √† ce stade.";
        ul.appendChild(li);
      } else {
        alerts.forEach(a=>{
          const li = document.createElement("li");
          li.textContent = a;
          ul.appendChild(li);
        });
      }

      // CDC
      const cdcLines = [];
      cdcLines.push("CAHIER DES CHARGES ‚Äî PR√â-QUALIFICATION (LEVAGE)");
      cdcLines.push("");
      cdcLines.push(`Pr√©cision : ${score}%`);
      cdcLines.push(complexity());
      cdcLines.push("");
      cdcLines.push("1) Op√©ration");
      cdcLines.push(`- Actions : ${act}`);

      if(state.action?.includes("lift") || state.action?.includes("move")){
        const mvMap = {
          v_updown:"Lever/descendre (vertical)",
          h_onesense:"Horizontal ‚Äî un sens",
          h_multisense:"Horizontal ‚Äî plusieurs sens",
          tilt:"Incliner",
          tip:"Basculer",
          flip:"Retourner (180¬∞)"
        };
        const mvTxt = (state.movement && state.movement.length) ? state.movement.map(x=>mvMap[x]||x).join(", ") : "Non renseign√©";
        cdcLines.push("");
        cdcLines.push("2) Mouvements");
        cdcLines.push(`- ${mvTxt}`);
      }

      if(state.action?.includes("lift") || state.action?.includes("move")){
        const locMap = { station:"Un poste d√©di√©", zone:"Une zone d√©finie", multi:"Plusieurs postes/zones" };
        cdcLines.push("");
        cdcLines.push("3) Organisation / lieu");
        cdcLines.push(`- ${state.location ? (locMap[state.location]||state.location) : "Non renseign√©"}${state["location_multisite"] ? " (+ multi-sites)" : ""}`);
      }

      if(state.action?.includes("hook")){
        cdcLines.push("");
        cdcLines.push("4) Prise de charge");
        if(state.anchorsPresence === true){
          const ptsMap = { p1:"1", p2:"2", p3:"3", p4:"4" };
          cdcLines.push("- Points d‚Äôancrage : Oui");
          cdcLines.push(`- Points d√©di√©s au levage : ${state["anchorsPresence_dedicated"] ? "Oui" : "Non / inconnu"}`);
          cdcLines.push(`- Nombre de points utilis√©s : ${state.anchorPoints ? (ptsMap[state.anchorPoints]||"?") : "Non renseign√©"}`);
        } else if(state.anchorsPresence === false){
          const gripMap = { positive:"Prise positive", clamp:"Serrage (pince)", suction:"Ventouses", mag:"Aimants" };
          cdcLines.push("- Points d‚Äôancrage : Non");
          cdcLines.push(`- M√©thode de prise : ${state.gripMethod ? (gripMap[state.gripMethod]||state.gripMethod) : "Non renseign√©"}`);
        } else {
          cdcLines.push("- Non renseign√©");
        }
      }

      const cgMap2 = { center:"Centr√©", decenter:"D√©centr√©", below:"Sous les points / instable" };
      cdcLines.push("");
      cdcLines.push("5) Centre de gravit√©");
      cdcLines.push(`- ${state.cog ? (cgMap2[state.cog]||state.cog) : "Non renseign√©"}`);

      const varMap2 = { unique:"Unique / proche", variation:"Variations ma√Ætris√©es", diverse:"Grande diversit√©" };
      cdcLines.push("");
      cdcLines.push("6) Variabilit√© des charges");
      cdcLines.push(`- ${state.loadVariability ? (varMap2[state.loadVariability]||state.loadVariability) : "Non renseign√©"}`);

      const hmMap2 = { safe:"S√©curitaire / robuste", precise:"Pr√©cise de positionnement", h_cg:"Horizontale ma√Ætrisant le CG" };
      cdcLines.push("");
      cdcLines.push("7) Mode de manutention attendu");
      cdcLines.push(`- ${state.handlingMode ? (hmMap2[state.handlingMode]||state.handlingMode) : "Non renseign√©"}`);

      cdcLines.push("");
      cdcLines.push("Remarques / points √† valider");
      if(alerts.length) alerts.forEach(a=>cdcLines.push(`- ${a}`));
      else cdcLines.push("- Aucun point bloquant d√©tect√© √† ce stade.");

      $("cdc").textContent = cdcLines.join("\n");

      setHeader();
      setStepPills();
      if(forceFocus && window.innerWidth < 980) focusSummary();
    }

    function resetAll(){
      for(const k of Object.keys(state)) delete state[k];
      dontKnowCount.total = 0;
      dontKnowCount.byId = {};
      stepIndex = 0;
      buildVisibleSteps();
      renderCurrent();
      renderSummary();
      focusQuestionBox();
    }

    function fillDemo(){
      resetAll();
      state.action = ["lift","move","hook","support"];
      state.movement = ["v_updown","h_multisense","tilt"];
      state.location = "multi";
      state["location_multisite"] = true;
      state.anchorsPresence = true;
      state["anchorsPresence_dedicated"] = true;
      state.anchorPoints = "p4";
      state.cog = "decenter";
      state.loadVariability = "variation";
      state.handlingMode = "precise";
      buildVisibleSteps();
      renderCurrent();
      renderSummary();
      focusQuestionBox();
    }

    async function copyCDC(){
      const txt = $("cdc").textContent || "";
      $("msg").textContent = "";
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(txt);
        } else {
          const ta=document.createElement("textarea");
          ta.value=txt; ta.style.position="fixed"; ta.style.left="-9999px";
          document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
        }
        $("msg").textContent = "Cahier des charges copi√© ‚úÖ";
        $("msg").style.color = "var(--good)";
        focusQuestionBox();
      }catch(e){
        $("msg").textContent = "Copie impossible : s√©lectionnez manuellement le texte.";
        $("msg").style.color = "var(--bad)";
      }
    }

    function downloadCDC(){
      const txt = $("cdc").textContent || "";
      const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download="cahier-des-charges-levage.txt";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    function bind(){
      $("validateBtn").addEventListener("click", validate);
      $("dontKnowBtn").addEventListener("click", dontKnow);
      $("backBtn").addEventListener("click", back);
      $("skipToSummaryBtn").addEventListener("click", ()=>{ renderSummary(true); focusSummary(); });
      $("resetBtn").addEventListener("click", resetAll);
      $("demoBtn").addEventListener("click", fillDemo);
      $("copyBtn").addEventListener("click", copyCDC);
      $("downloadBtn").addEventListener("click", downloadCDC);
      $("callBtn").addEventListener("click", ()=> alert("üëâ Contact sp√©cialiste : copiez le cahier des charges et envoyez-le au commercial."));
    }

    // Init
    buildVisibleSteps();
    bind();
    renderCurrent();
    renderSummary();
    window.addEventListener("load", ()=> setTimeout(focusQuestionBox, 50));
  </script>
</body>
</html>